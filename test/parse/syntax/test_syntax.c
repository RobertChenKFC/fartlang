#include "parse/syntax/syntax.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <float.h>

void PrintChar(FILE *file, char c) {
  switch (c) {
    case '\a':
      fprintf(file, "\\a");
      break;
    case '\b':
      fprintf(file, "\\b");
      break;
    case '\f':
      fprintf(file, "\\f");
      break;
    case '\n':
      fprintf(file, "\\n");
      break;
    case '\r':
      fprintf(file, "\\r");
      break;
    case '\t':
      fprintf(file, "\\t");
      break;
    case '\v':
      fprintf(file, "\\v");
      break;
    case '\\':
      fprintf(file, "\\\\");
      break;
    case '\'':
      fprintf(file, "\\'");
      break;
    case '\"':
      fprintf(file, "\\\"");
      break;
    case '\0':
      fprintf(file, "\\0");
      break;
    default:
      fprintf(file, "%c", c);
      break;
  }
}

void PrintStr(FILE *file, char *str) {
  char c;
  fprintf(file, "\"");
  while ((c = *str)) {
    PrintChar(file, c);
    ++str;
  }
  fprintf(file, "\"");
}

void PrintLiteral(FILE *file, SyntaxAST *node) {
  fprintf(file, "type %s, value ", SYNTAX_TYPE_STRS[node->literal.type]);
  switch (node->literal.type) {
    case SYNTAX_TYPE_U64:
    case SYNTAX_TYPE_I64:
    case SYNTAX_TYPE_U32:
    case SYNTAX_TYPE_I32:
    case SYNTAX_TYPE_U16:
    case SYNTAX_TYPE_I16:
    case SYNTAX_TYPE_U8:
    case SYNTAX_TYPE_I8:
      fprintf(file, "%llu", (unsigned long long)node->literal.intVal);
      break;
    case SYNTAX_TYPE_F64:
    case SYNTAX_TYPE_F32:
      fprintf(file, "%.*e", DBL_DECIMAL_DIG - 1, node->literal.floatVal);
      break;
    case SYNTAX_TYPE_BOOL:
      if (node->literal.boolVal)
        fprintf(file, "true");
      else
        fprintf(file, "false");
      break;
    case SYNTAX_TYPE_STR:
      PrintStr(file, node->literal.strVal);
      break;
  }
}

void PrintAST(FILE *file, SyntaxAST *node, int indentation) {
  if (!node)
    return;
  for (int i = 0; i < indentation; ++i)
    fprintf(file, " ");
  fprintf(file, "%s: %d:%d~%d:%d: ", SYNTAX_AST_KIND_STRS[node->kind],
          node->loc.from.lineNo + 1, node->loc.from.charNo + 1,
          node->loc.to.lineNo + 1, node->loc.to.charNo + 1);

  switch (node->kind) {
    case SYNTAX_AST_KIND_IDENTIFIER:
      fprintf(file, "%s: ", node->string);
      break;
    case SYNTAX_AST_KIND_IMPORT_DECL:
      if (node->import.isWildcard)
        fprintf(file, "wildcard: ");
      else if (node->import.namespace)
        fprintf(file, "under namespace \"%s\": ", node->import.namespace);
      break;
    case SYNTAX_AST_KIND_VAR_DECL:
      if (node->varDeclModifiers & SYNTAX_VAR_DECL_STATIC) {
        if (node->varDeclModifiers & SYNTAX_VAR_DECL_CONST)
          fprintf(file, "static and const: ");
        else
          fprintf(file, "static: ");
      } else if (node->varDeclModifiers & SYNTAX_VAR_DECL_CONST) {
        fprintf(file, "const: ");
      }
      break;
    case SYNTAX_AST_KIND_TYPE:
      fprintf(file, "base type: %s, array levels: %d, child types: ",
              SYNTAX_TYPE_STRS[node->type.baseType], node->type.arrayLevels);
      break;
    case SYNTAX_AST_KIND_VAR_INIT:
      fprintf(file, "variable: %s: ", node->string);
      break;
    case SYNTAX_AST_KIND_LITERAL:
      PrintLiteral(file, node);
      break;
    case SYNTAX_AST_KIND_OP:
    case SYNTAX_AST_KIND_ASSIGN:
      fprintf(file, "op: %s: ", SYNTAX_OP_STRS[node->op]);
      break;
    case SYNTAX_AST_KIND_MEMBER_ACCESS:
      fprintf(file, "member: %s: ", node->string);
      break;
    case SYNTAX_AST_KIND_METHOD_DECL:
      fprintf(file, "type: %s, name: %s: ",
          SYNTAX_METHOD_TYPE_STRS[node->method.type], node->method.name);
      break;
    case SYNTAX_AST_KIND_PARAM:
      fprintf(file, "name: %s: ", node->string);
      break;
  }
  fprintf(file, "\n");
  for (SyntaxAST *child = node->firstChild; child; child = child->sibling)
    PrintAST(file, child, indentation + 4);
}

void PrintFloat(FILE *file, SyntaxAST *node, int indentation) {
  if (!node)
    return;
  if (node->kind == SYNTAX_AST_KIND_LITERAL &&
      (node->literal.type == SYNTAX_TYPE_F64 ||
       node->literal.type == SYNTAX_TYPE_F32)) {
    uint64_t bits;
    memcpy(&bits, &node->literal.floatVal, sizeof(bits));
    fprintf(file, "%llx\n", (unsigned long long)bits);
    return;
  }
  for (SyntaxAST *child = node->firstChild; child; child = child->sibling)
    PrintFloat(file, child, indentation);
}

typedef void (*PrintFunc)(FILE*, SyntaxAST*, int);
void RunTest(const char *testName, PrintFunc print) {
  char *str = malloc(strlen(testName) + 6);
  strcpy(str, testName);
  strcat(str, ".fart");
  FILE *file = fopen(str, "r");
  SyntaxAST *node = SyntaxParseFile(file, str);
  fclose(file);

  strcpy(str, testName);
  strcat(str, ".out");
  file = fopen(str, "w");
  print(file, node, 0);
  fclose(file);

  SyntaxASTDelete(node);
  free(str);
}

void AstTest(const char *filename) {
  RunTest(filename, PrintAST);
}

void GenFloatTest(void) {
  const char *floatStrs[] = {
    "12345",
    "12345.6789",
    "12345.6788",
    "0.75",
    // 2^1023
    "89884656743115795386465259539451236680898848947115328636715040578866337902750481566354238661203768010560056939935696678829394884407208311246423715319737062188883946712432742638151109800623047059726541476042502884419075341171231440736956555270413618581675255342293149119973622969239858152417678164812112068608",
    // 2^1023+1
    "89884656743115795386465259539451236680898848947115328636715040578866337902750481566354238661203768010560056939935696678829394884407208311246423715319737062188883946712432742638151109800623047059726541476042502884419075341171231440736956555270413618581675255342293149119973622969239858152417678164812112068609",
    // 2^1023 * 10
    "898846567431157953864652595394512366808988489471153286367150405788663379027504815663542386612037680105600569399356966788293948844072083112464237153197370621888839467124327426381511098006230470597265414760425028844190753411712314407369565552704136185816752553422931491199736229692398581524176781648121120686080",
    // 2^(-1022) + 2^(-1022-52)
    "0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022250738585072018771558785585789482407880088486837041956131300312119688603996006965297904292212628858639037013670281908017171296072711910355127227413175152199055740043138804567803233377539881639177387328959246074229270113078053813397081653361296447449529789521218979090783852583365901851789618799885150427514782636076021680436220311292700454832073964845713103912225963935608322440623896907276890186717054549275173986589324810401738228328251245795065655738191038008646911615828719989708647293221449796971546706720399791990809160347625980385995424739847678861180095072511543762389603716215171729816011544604359531284325406441938645324905389137795680915804792405099227413854274942620542640408839836919187418172987793340279242767544565229087538682506419718265533447265625",
    // 2^(-1022) + 2^(-1022-53)
    "0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000222507385850720163012305563795567615250361241457301801308322872404958664760675944619203679411688695321398552054903200090343478188441232557218436756334761702051817599892294139362996674259828589999483014897143355557856769327930601597818316214242506796246078529588519927249357768832073249247992481686923224716596493432925878395010225097395757951057160073834364573849432419299709217920738991976169431413149717326525502008499797367678374315520581880443916381057236779117517775622749741380425338708447819365553307386742083452616251302946202273010905482006765402020154711200202813970014157525912344017736224427371246815175018974555997865323425588621961151633592416795802960447706494647018477736093430045142168360701364747951396213837722826145437693412532098591327667236328125",
    // 2^(-1022) + 2^(-1022-52) + 2^(-1022-53)
    "0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000222507385850720212418870147920222032907240528279439037814303133837435107319244194686754406432563881851382188218502438069999947733013005649884107791928741341929297200970481951993067993290969042784064731682041565926728632933630474670123316852983422152744517260835859654566319282835244787787799894310779783833699159288594555213714181128458251145584319223079897504395086859412457230891738946169368372321191373658977977723286698840356390251044443035457396733706583981055420456693824658413747607155981176573877626747665912387199931904006317334709003012790188175203447190250028061277777916798391090578584006464715943810511489154282775041174682194133952466682503431306181587829379004205392375072083366693241580002758391118854188641513168478436313080237596295773983001708984375",
    "0",
    // 0xdeadbeefdeadbeefdeadbeef
    "68915718021581205938132336367",
    // 0xabcdefabcdefabcdefabcdef
    "53170898287292916380478459375",
    // (((0xfedcba9876543 << 1) | 1) << 64)
    "165415039475456211208501591099310080",
    // (((0xfedcba9876543 << 1) | 1) << 64) | (1 << 63)
    "165415039475456220431873627954085888",
    // 2^(-1024)
    "0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055626846462680034577255817933310101605480399511558295763833185422180110870347954896357078975312775514101683493275895275128810854038836502721400309634442970528269449838300058261990253686064590901798039126173562593355209381270166265416453973718012279499214790991212515897719252957621869994522193843748736289511290126272884996414561770466127838448395124802899527144151299810833802858809753719892490239782222290074816037776586657834841586939662825734294051183140794537141608771803070715941051121170285190347786926570042246331102750604036185540464179153763503857127117918822547579033069472418242684328083352174724579376695971173152319349449321466491373527284227385153411689217559966957882267024615430273115634918212890625",
    // 2^(-1022-52)
    "0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004940656458412465441765687928682213723650598026143247644255856825006755072702087518652998363616359923797965646954457177309266567103559397963987747960107818781263007131903114045278458171678489821036887186360569987307230500063874091535649843873124733972731696151400317153853980741262385655911710266585566867681870395603106249319452715914924553293054565444011274801297099995419319894090804165633245247571478690147267801593552386115501348035264934720193790268107107491703332226844753335720832431936092382893458368060106011506169809753078342277318329247904982524730776375927247874656084778203734469699533647017972677717585125660551199131504891101451037862738167250955837389733598993664809941164205702637090279242767544565229087538682506419718265533447265625",
    // 2^(-1022-52)+2^(-1022-53)
    "0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000074109846876186981626485318930233205854758970392148714663837852375101326090531312779794975454245398856969484704316857659638998506553390969459816219401617281718945106978546710679176872575177347315553307795408549809608457500958111373034747658096871009590975442271004757307809711118935784838675653998783503015228055934046593739791790738723868299395818481660169122019456499931289798411362062484498678713572180352209017023903285791732520220528974020802906854021606612375549983402671300035812486479041385743401875520901590172592547146296175134159774938718574737870961645638908718119841271673056017045493004705269590165763776884908267986972573366521765567941072508764337560846003984904972149117463085539556354188641513168478436313080237596295773983001708984375",
    // 2^(-1022-53)
    "0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024703282292062327208828439643411068618252990130716238221279284125033775363510437593264991818081799618989828234772285886546332835517796989819938739800539093906315035659515570226392290858392449105184435931802849936536152500319370457678249219365623669863658480757001585769269903706311928279558551332927834338409351978015531246597263579574622766465272827220056374006485499977096599470454020828166226237857393450736339007967761930577506740176324673600968951340535537458516661134223766678604162159680461914467291840300530057530849048765391711386591646239524912623653881879636239373280423891018672348497668235089863388587925628302755995657524455507255189313690836254779186948667994968324049705821028513185451396213837722826145437693412532098591327667236328125",
    "3.28e-7",
    "3.28e4",
    "3.28e1",
    "1.234e2",
    "5678.9e-3",
    "6.023e+23",
    "8.99e9",
    "6.67430e-11",
    "10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-2000",
    "20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-1999",
    "30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e-1998",
    NULL
  };

  FILE *fartFile = fopen("float.fart", "w");
  FILE *refFile = fopen("float.ref", "w");
  fprintf(fartFile, "class Float {\n");
  for (int i = 0; floatStrs[i]; ++i) {
    fprintf(fartFile, "  var x = %sf64;\n", floatStrs[i]);
    double x = atof(floatStrs[i]);
    uint64_t y;
    memcpy(&y, &x, sizeof(y));
    fprintf(refFile, "%llx\n", (unsigned long long)y);
  }
  fprintf(fartFile, "}\n");
  fclose(fartFile);
  fclose(refFile);
}

void FloatTest(const char *filename) {
  GenFloatTest();
  RunTest(filename, PrintFloat);
}

int main(void) {
  AstTest("import");
  AstTest("vardecl");
  FloatTest("float");
  AstTest("term");
  AstTest("expr");
  AstTest("methoddecl");
  AstTest("stmt");
  AstTest("test");
}
